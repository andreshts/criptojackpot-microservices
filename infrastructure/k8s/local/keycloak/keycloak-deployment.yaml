# Keycloak Deployment para desarrollo local
# Single replica con recursos limitados para desarrollo
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: cryptojackpot
  labels:
    app: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
        - name: keycloak
          # Verificar últimas versiones: https://www.keycloak.org/downloads
          # Última actualización: Febrero 2026
          image: quay.io/keycloak/keycloak:26.5.2
          imagePullPolicy: Always
          args:
            - start-dev
            - --import-realm
          envFrom:
            - configMapRef:
                name: keycloak-config
            - secretRef:
                name: keycloak-secrets
          ports:
            - name: http
              containerPort: 8080
          volumeMounts:
            - name: realm-config
              mountPath: /opt/keycloak/data/import
              readOnly: true
            # Login theme templates
            - name: login-theme-properties
              mountPath: /opt/keycloak/themes/cryptojackpot/login/theme.properties
              subPath: theme.properties
            - name: login-theme-css
              mountPath: /opt/keycloak/themes/cryptojackpot/login/resources/css/login.css
              subPath: login.css
            - name: login-theme-messages-en
              mountPath: /opt/keycloak/themes/cryptojackpot/login/messages/messages_en.properties
              subPath: messages_en.properties
            - name: login-theme-messages-es
              mountPath: /opt/keycloak/themes/cryptojackpot/login/messages/messages_es.properties
              subPath: messages_es.properties
            - name: login-theme-login
              mountPath: /opt/keycloak/themes/cryptojackpot/login/login.ftl
              subPath: login.ftl
            - name: login-theme-register
              mountPath: /opt/keycloak/themes/cryptojackpot/login/register.ftl
              subPath: register.ftl
            - name: login-theme-reset-password
              mountPath: /opt/keycloak/themes/cryptojackpot/login/login-reset-password.ftl
              subPath: login-reset-password.ftl
            - name: login-theme-update-password
              mountPath: /opt/keycloak/themes/cryptojackpot/login/login-update-password.ftl
              subPath: login-update-password.ftl
            - name: login-theme-verify-email
              mountPath: /opt/keycloak/themes/cryptojackpot/login/login-verify-email.ftl
              subPath: login-verify-email.ftl
            # Email theme templates
            - name: email-theme-properties
              mountPath: /opt/keycloak/themes/cryptojackpot/email/theme.properties
              subPath: theme.properties
            - name: email-theme-messages-en
              mountPath: /opt/keycloak/themes/cryptojackpot/email/messages/messages_en.properties
              subPath: messages_en.properties
            - name: email-theme-messages-es
              mountPath: /opt/keycloak/themes/cryptojackpot/email/messages/messages_es.properties
              subPath: messages_es.properties
            - name: email-theme-template
              mountPath: /opt/keycloak/themes/cryptojackpot/email/html/template.ftl
              subPath: template.ftl
            - name: email-theme-verification
              mountPath: /opt/keycloak/themes/cryptojackpot/email/html/email-verification.ftl
              subPath: email-verification.ftl
            - name: email-theme-password-reset
              mountPath: /opt/keycloak/themes/cryptojackpot/email/html/password-reset.ftl
              subPath: password-reset.ftl
            - name: email-theme-execute-actions
              mountPath: /opt/keycloak/themes/cryptojackpot/email/html/executeActions.ftl
              subPath: executeActions.ftl
            - name: email-theme-verification-text
              mountPath: /opt/keycloak/themes/cryptojackpot/email/text/email-verification.ftl
              subPath: email-verification-text.ftl
            - name: email-theme-password-reset-text
              mountPath: /opt/keycloak/themes/cryptojackpot/email/text/password-reset.ftl
              subPath: password-reset-text.ftl
            - name: email-theme-execute-actions-text
              mountPath: /opt/keycloak/themes/cryptojackpot/email/text/executeActions.ftl
              subPath: executeActions-text.ftl
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          # Security hardening
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 9000
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /health/live
              port: 9000
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /health/started
              port: 9000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
      volumes:
        - name: realm-config
          configMap:
            name: keycloak-realm-config
        # Login theme volumes from ConfigMap
        - name: login-theme-properties
          configMap:
            name: keycloak-login-theme
            items:
              - key: theme.properties
                path: theme.properties
        - name: login-theme-css
          configMap:
            name: keycloak-login-theme
            items:
              - key: login.css
                path: login.css
        - name: login-theme-messages-en
          configMap:
            name: keycloak-login-theme
            items:
              - key: messages_en.properties
                path: messages_en.properties
        - name: login-theme-messages-es
          configMap:
            name: keycloak-login-theme
            items:
              - key: messages_es.properties
                path: messages_es.properties
        - name: login-theme-login
          configMap:
            name: keycloak-login-theme
            items:
              - key: login.ftl
                path: login.ftl
        - name: login-theme-register
          configMap:
            name: keycloak-login-theme
            items:
              - key: register.ftl
                path: register.ftl
        - name: login-theme-reset-password
          configMap:
            name: keycloak-login-theme
            items:
              - key: login-reset-password.ftl
                path: login-reset-password.ftl
        - name: login-theme-update-password
          configMap:
            name: keycloak-login-theme
            items:
              - key: login-update-password.ftl
                path: login-update-password.ftl
        - name: login-theme-verify-email
          configMap:
            name: keycloak-login-theme
            items:
              - key: login-verify-email.ftl
                path: login-verify-email.ftl
        # Email theme volumes from ConfigMap
        - name: email-theme-properties
          configMap:
            name: keycloak-email-themes
            items:
              - key: theme.properties
                path: theme.properties
        - name: email-theme-messages-en
          configMap:
            name: keycloak-email-themes
            items:
              - key: messages_en.properties
                path: messages_en.properties
        - name: email-theme-messages-es
          configMap:
            name: keycloak-email-themes
            items:
              - key: messages_es.properties
                path: messages_es.properties
        - name: email-theme-template
          configMap:
            name: keycloak-email-themes
            items:
              - key: template.ftl
                path: template.ftl
        - name: email-theme-verification
          configMap:
            name: keycloak-email-themes
            items:
              - key: email-verification.ftl
                path: email-verification.ftl
        - name: email-theme-password-reset
          configMap:
            name: keycloak-email-themes
            items:
              - key: password-reset.ftl
                path: password-reset.ftl
        - name: email-theme-execute-actions
          configMap:
            name: keycloak-email-themes
            items:
              - key: executeActions.ftl
                path: executeActions.ftl
        - name: email-theme-verification-text
          configMap:
            name: keycloak-email-themes
            items:
              - key: email-verification-text.ftl
                path: email-verification-text.ftl
        - name: email-theme-password-reset-text
          configMap:
            name: keycloak-email-themes
            items:
              - key: password-reset-text.ftl
                path: password-reset-text.ftl
        - name: email-theme-execute-actions-text
          configMap:
            name: keycloak-email-themes
            items:
              - key: executeActions-text.ftl
                path: executeActions-text.ftl
