# Job para crear los topics de Kafka necesarios
apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-create-topics
  namespace: cryptojackpot
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      initContainers:
        - name: wait-for-redpanda
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z redpanda.cryptojackpot.svc.cluster.local 9092; do
                echo "Waiting for Redpanda..."
                sleep 2
              done
              echo "Redpanda is ready!"
      containers:
        - name: create-topics
          image: docker.redpanda.com/redpandadata/redpanda:v23.3.5
          command:
            - sh
            - -c
            - |
              echo "Creating Kafka topics..."
              
              # Identity Events
              rpk topic create user-registered --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create user-logged-in --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create password-reset-requested --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create referral-created --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create get-users-for-marketing-request --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create get-users-for-marketing-response --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              
              # Lottery Events
              rpk topic create lottery-created --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create numbers-reserved --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create numbers-released --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create numbers-sold --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              
              # Order Events
              rpk topic create order-created --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create order-completed --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create order-expired --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create order-cancelled --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              
              # Notification Events
              rpk topic create email-sent --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create notification-failed --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              rpk topic create send-marketing-email --brokers=redpanda.cryptojackpot.svc.cluster.local:9092 -p 3 -r 1 || true
              
              echo "All topics created!"
              rpk topic list --brokers=redpanda.cryptojackpot.svc.cluster.local:9092
      restartPolicy: OnFailure
