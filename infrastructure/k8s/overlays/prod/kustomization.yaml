# Kustomization for PRODUCTION environment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: cryptojackpot

resources:
  - ../../base
  - secrets
  - pgbouncer

# PROD uses managed services:
# - DigitalOcean Managed PostgreSQL
# - Upstash Redis
# - Upstash Kafka
# - DigitalOcean Spaces
# - MongoDB Atlas

patches:
  # Identity API - replicas, resources, security, Kafka SASL
  - target:
      kind: Deployment
      name: identity-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Lottery API
  - target:
      kind: Deployment
      name: lottery-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Order API
  - target:
      kind: Deployment
      name: order-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Wallet API
  - target:
      kind: Deployment
      name: wallet-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Winner API
  - target:
      kind: Deployment
      name: winner-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Notification API
  - target:
      kind: Deployment
      name: notification-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Audit API
  - target:
      kind: Deployment
      name: audit-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # BFF Gateway
  - target:
      kind: Deployment
      name: bff-gateway
    patch: |-
      - op: add
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # BFF Ingress - Add TLS, host, and rate limiting for production (JSON patch for complete rule replacement)
  - target:
      kind: Ingress
      name: bff-ingress
    patch: |-
      - op: add
        path: /metadata/annotations/cert-manager.io~1cluster-issuer
        value: letsencrypt-prod
      - op: add
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1limit-rps
        value: "100"
      - op: add
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1limit-connections
        value: "50"
      - op: add
        path: /spec/tls
        value:
          - hosts:
              - api.criptojackpot.com
            secretName: criptojackpot-prod-tls
      - op: replace
        path: /spec/rules
        value:
          - host: api.criptojackpot.com
            http:
              paths:
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: bff-gateway
                      port:
                        number: 80
                - path: /lottery-hub
                  pathType: Prefix
                  backend:
                    service:
                      name: bff-gateway
                      port:
                        number: 80
                - path: /health
                  pathType: Prefix
                  backend:
                    service:
                      name: bff-gateway
                      port:
                        number: 80

# ConfigMap for Production environment
configMapGenerator:
  - name: app-config
    literals:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - Logging__LogLevel__Default=Warning
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - Cors__AllowedOrigins__0=https://criptojackpot.com
      - Cors__AllowedOrigins__1=https://www.criptojackpot.com

generatorOptions:
  disableNameSuffixHash: true

images:
  - name: cryptojackpot/bff-gateway
    newName: registry.digitalocean.com/criptojackpot/bff-gateway
    newTag: v1.0.0
  - name: cryptojackpot/identity-api
    newName: registry.digitalocean.com/criptojackpot/identity-api
    newTag: v1.0.0
  - name: cryptojackpot/lottery-api
    newName: registry.digitalocean.com/criptojackpot/lottery-api
    newTag: v1.0.0
  - name: cryptojackpot/order-api
    newName: registry.digitalocean.com/criptojackpot/order-api
    newTag: v1.0.0
  - name: cryptojackpot/wallet-api
    newName: registry.digitalocean.com/criptojackpot/wallet-api
    newTag: v1.0.0
  - name: cryptojackpot/winner-api
    newName: registry.digitalocean.com/criptojackpot/winner-api
    newTag: v1.0.0
  - name: cryptojackpot/notification-api
    newName: registry.digitalocean.com/criptojackpot/notification-api
    newTag: v1.0.0
  - name: cryptojackpot/audit-api
    newName: registry.digitalocean.com/criptojackpot/audit-api
    newTag: v1.0.0

labels:
  - pairs:
      environment: production
    includeSelectors: false
