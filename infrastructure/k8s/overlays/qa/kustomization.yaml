# Kustomization for QA environment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: cryptojackpot

resources:
  - ../../base
  - secrets
  - ingress
  - pgbouncer

# QA uses managed services (no local infrastructure)
# - DigitalOcean Managed PostgreSQL
# - Upstash Redis
# - Upstash Kafka
# - DigitalOcean Spaces
# - MongoDB Atlas

patches:
  # Identity API - replicas, resources, security
  - target:
      kind: Deployment
      name: identity-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # Lottery API
  - target:
      kind: Deployment
      name: lottery-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # Order API
  - target:
      kind: Deployment
      name: order-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # Wallet API
  - target:
      kind: Deployment
      name: wallet-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # Winner API
  - target:
      kind: Deployment
      name: winner-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # Notification API
  - target:
      kind: Deployment
      name: notification-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # Audit API
  - target:
      kind: Deployment
      name: audit-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

# ConfigMap for QA environment
configMapGenerator:
  - name: app-config
    literals:
      - ASPNETCORE_ENVIRONMENT=Staging
      - ASPNETCORE_URLS=http://+:80
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - Cors__AllowedOrigins__0=https://qa.cryptojackpot.com
      - Keycloak__Authority=https://auth-qa.cryptojackpot.com
      - Keycloak__Realm=cryptojackpot
      - Keycloak__ClientId=cryptojackpot-backend
      - Keycloak__RequireHttpsMetadata=true
      - Keycloak__ValidateAudience=true

generatorOptions:
  disableNameSuffixHash: true

images:
  - name: cryptojackpot/identity-api
    newName: registry.digitalocean.com/cryptojackpot/identity-api
    newTag: qa
  - name: cryptojackpot/lottery-api
    newName: registry.digitalocean.com/cryptojackpot/lottery-api
    newTag: qa
  - name: cryptojackpot/order-api
    newName: registry.digitalocean.com/cryptojackpot/order-api
    newTag: qa
  - name: cryptojackpot/wallet-api
    newName: registry.digitalocean.com/cryptojackpot/wallet-api
    newTag: qa
  - name: cryptojackpot/winner-api
    newName: registry.digitalocean.com/cryptojackpot/winner-api
    newTag: qa
  - name: cryptojackpot/notification-api
    newName: registry.digitalocean.com/cryptojackpot/notification-api
    newTag: qa
  - name: cryptojackpot/audit-api
    newName: registry.digitalocean.com/cryptojackpot/audit-api
    newTag: qa

labels:
  - pairs:
      environment: qa
    includeSelectors: false
