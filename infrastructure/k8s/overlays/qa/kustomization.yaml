# Kustomization for QA environment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: cryptojackpot

resources:
  - ../../base
  - secrets
  - pgbouncer

# QA uses managed services (no local infrastructure):
# - DigitalOcean Managed PostgreSQL (via PgBouncer)
# - Upstash Redis
# - Upstash Kafka (SASL/SSL)
# - DigitalOcean Spaces
# - MongoDB Atlas
# External access: ONLY through BFF Gateway Ingress (api-qa.criptojackpot.com)
# All microservices are ClusterIP - internal only

patches:
  # Identity API - replicas, resources, security, Kafka SASL
  - target:
      kind: Deployment
      name: identity-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Lottery API
  - target:
      kind: Deployment
      name: lottery-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Order API
  - target:
      kind: Deployment
      name: order-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Wallet API
  - target:
      kind: Deployment
      name: wallet-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Winner API
  - target:
      kind: Deployment
      name: winner-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Notification API
  - target:
      kind: Deployment
      name: notification-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # Audit API
  - target:
      kind: Deployment
      name: audit-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslUsername
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_USERNAME
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslPassword
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_PASSWORD
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SaslMechanism
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SASL_MECHANISM
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: Kafka__SecurityProtocol
          valueFrom:
            secretKeyRef:
              name: kafka-secrets
              key: KAFKA_SECURITY_PROTOCOL

  # BFF Gateway - único punto de entrada externo
  - target:
      kind: Deployment
      name: bff-gateway
    patch: |-
      - op: add
        path: /spec/replicas
        value: 2
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
      - op: add
        path: /spec/template/spec/containers/0/securityContext
        value:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "125m"

  # BFF Ingress - único punto de entrada externo (api-qa.criptojackpot.com)
  # Todos los microservicios son ClusterIP - solo accesibles internamente desde el BFF
  - target:
      kind: Ingress
      name: bff-ingress
    patch: |-
      - op: add
        path: /metadata/annotations/cert-manager.io~1cluster-issuer
        value: letsencrypt-prod
      - op: add
        path: /spec/tls
        value:
          - hosts:
              - api-qa.criptojackpot.com
            secretName: criptojackpot-qa-tls
      - op: replace
        path: /spec/rules
        value:
          - host: api-qa.criptojackpot.com
            http:
              paths:
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: bff-gateway
                      port:
                        number: 80
                - path: /lottery-hub
                  pathType: Prefix
                  backend:
                    service:
                      name: bff-gateway
                      port:
                        number: 80
                - path: /health
                  pathType: Prefix
                  backend:
                    service:
                      name: bff-gateway
                      port:
                        number: 80

# ConfigMap for QA environment
configMapGenerator:
  - name: app-config
    literals:
      - ASPNETCORE_ENVIRONMENT=Staging
      - ASPNETCORE_URLS=http://+:80
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - Cors__AllowedOrigins__0=https://qa.criptojackpot.com

generatorOptions:
  disableNameSuffixHash: true

images:
  - name: cryptojackpot/bff-gateway
    newName: registry.digitalocean.com/criptojackpot/bff-gateway
    newTag: qa
  - name: cryptojackpot/identity-api
    newName: registry.digitalocean.com/criptojackpot/identity-api
    newTag: qa
  - name: cryptojackpot/lottery-api
    newName: registry.digitalocean.com/criptojackpot/lottery-api
    newTag: qa
  - name: cryptojackpot/order-api
    newName: registry.digitalocean.com/criptojackpot/order-api
    newTag: qa
  - name: cryptojackpot/wallet-api
    newName: registry.digitalocean.com/criptojackpot/wallet-api
    newTag: qa
  - name: cryptojackpot/winner-api
    newName: registry.digitalocean.com/criptojackpot/winner-api
    newTag: qa
  - name: cryptojackpot/notification-api
    newName: registry.digitalocean.com/criptojackpot/notification-api
    newTag: qa
  - name: cryptojackpot/audit-api
    newName: registry.digitalocean.com/criptojackpot/audit-api
    newTag: qa

labels:
  - pairs:
      environment: qa
    includeSelectors: false
