# Kustomization for LOCAL environment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: cryptojackpot

resources:
  - ../../base
  - ../../base/infrastructure
  - secrets
  - configmaps
  - ingress
  - jobs

# Environment-specific patches using JSON Patch
patches:
  # Identity API - replicas, resources, initContainer
  - target:
      kind: Deployment
      name: identity-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 1
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: wait-for-postgres
            image: busybox:1.36
            command: ["sh", "-c", "echo 'Waiting for DNS and PostgreSQL...'; sleep 5; until nslookup postgres.cryptojackpot.svc.cluster.local > /dev/null 2>&1 && nc -z postgres.cryptojackpot.svc.cluster.local 5432; do echo 'Waiting for PostgreSQL...'; sleep 3; done; echo 'PostgreSQL is ready!'"]
          - name: wait-for-migrations
            image: bitnami/kubectl:latest
            command: ["sh", "-c", "echo 'Waiting for migrations...'; kubectl wait --for=condition=complete job/db-migrations -n cryptojackpot --timeout=120s 2>/dev/null || echo 'Migration job not found or already completed'; echo 'Proceeding with startup.'"]
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  # Lottery API
  - target:
      kind: Deployment
      name: lottery-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 1
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: wait-for-postgres
            image: busybox:1.36
            command: ["sh", "-c", "echo 'Waiting for DNS and PostgreSQL...'; sleep 5; until nslookup postgres.cryptojackpot.svc.cluster.local > /dev/null 2>&1 && nc -z postgres.cryptojackpot.svc.cluster.local 5432; do echo 'Waiting for PostgreSQL...'; sleep 3; done; echo 'PostgreSQL is ready!'"]
          - name: wait-for-migrations
            image: bitnami/kubectl:latest
            command: ["sh", "-c", "echo 'Waiting for migrations...'; kubectl wait --for=condition=complete job/db-migrations -n cryptojackpot --timeout=120s 2>/dev/null || echo 'Migration job not found or already completed'; echo 'Proceeding with startup.'"]
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  # Order API
  - target:
      kind: Deployment
      name: order-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 1
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: wait-for-postgres
            image: busybox:1.36
            command: ["sh", "-c", "echo 'Waiting for DNS and PostgreSQL...'; sleep 5; until nslookup postgres.cryptojackpot.svc.cluster.local > /dev/null 2>&1 && nc -z postgres.cryptojackpot.svc.cluster.local 5432; do echo 'Waiting for PostgreSQL...'; sleep 3; done; echo 'PostgreSQL is ready!'"]
          - name: wait-for-migrations
            image: bitnami/kubectl:latest
            command: ["sh", "-c", "echo 'Waiting for migrations...'; kubectl wait --for=condition=complete job/db-migrations -n cryptojackpot --timeout=120s 2>/dev/null || echo 'Migration job not found or already completed'; echo 'Proceeding with startup.'"]
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  # Wallet API
  - target:
      kind: Deployment
      name: wallet-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 1
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: wait-for-postgres
            image: busybox:1.36
            command: ["sh", "-c", "echo 'Waiting for DNS and PostgreSQL...'; sleep 5; until nslookup postgres.cryptojackpot.svc.cluster.local > /dev/null 2>&1 && nc -z postgres.cryptojackpot.svc.cluster.local 5432; do echo 'Waiting for PostgreSQL...'; sleep 3; done; echo 'PostgreSQL is ready!'"]
          - name: wait-for-migrations
            image: bitnami/kubectl:latest
            command: ["sh", "-c", "echo 'Waiting for migrations...'; kubectl wait --for=condition=complete job/db-migrations -n cryptojackpot --timeout=120s 2>/dev/null || echo 'Migration job not found or already completed'; echo 'Proceeding with startup.'"]
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  # Winner API
  - target:
      kind: Deployment
      name: winner-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 1
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: wait-for-postgres
            image: busybox:1.36
            command: ["sh", "-c", "echo 'Waiting for DNS and PostgreSQL...'; sleep 5; until nslookup postgres.cryptojackpot.svc.cluster.local > /dev/null 2>&1 && nc -z postgres.cryptojackpot.svc.cluster.local 5432; do echo 'Waiting for PostgreSQL...'; sleep 3; done; echo 'PostgreSQL is ready!'"]
          - name: wait-for-migrations
            image: bitnami/kubectl:latest
            command: ["sh", "-c", "echo 'Waiting for migrations...'; kubectl wait --for=condition=complete job/db-migrations -n cryptojackpot --timeout=120s 2>/dev/null || echo 'Migration job not found or already completed'; echo 'Proceeding with startup.'"]
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  # Notification API
  - target:
      kind: Deployment
      name: notification-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 1
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: wait-for-postgres
            image: busybox:1.36
            command: ["sh", "-c", "echo 'Waiting for DNS and PostgreSQL...'; sleep 5; until nslookup postgres.cryptojackpot.svc.cluster.local > /dev/null 2>&1 && nc -z postgres.cryptojackpot.svc.cluster.local 5432; do echo 'Waiting for PostgreSQL...'; sleep 3; done; echo 'PostgreSQL is ready!'"]
          - name: wait-for-migrations
            image: bitnami/kubectl:latest
            command: ["sh", "-c", "echo 'Waiting for migrations...'; kubectl wait --for=condition=complete job/db-migrations -n cryptojackpot --timeout=120s 2>/dev/null || echo 'Migration job not found or already completed'; echo 'Proceeding with startup.'"]
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  # Audit API (MongoDB)
  - target:
      kind: Deployment
      name: audit-api
    patch: |-
      - op: add
        path: /spec/replicas
        value: 1
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: wait-for-mongodb
            image: busybox:1.36
            command: ["sh", "-c", "until nc -z mongodb.cryptojackpot.svc.cluster.local 27017; do echo 'Waiting for MongoDB...'; sleep 2; done; echo 'MongoDB is ready!'"]
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

# ConfigMap for local environment
configMapGenerator:
  - name: app-config
    literals:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - POSTGRES_HOST=postgres.cryptojackpot.svc.cluster.local
      - POSTGRES_PORT=5432
      - KAFKA_BOOTSTRAP_SERVERS=redpanda.cryptojackpot.svc.cluster.local:9092
      - ConnectionStrings__RedisConnection=redis.cryptojackpot.svc.cluster.local:6379
      - Cors__AllowedOrigins__0=http://localhost:3000
      - Cors__AllowedOrigins__1=http://cryptojackpot.local
      - Cors__AllowedOrigins__2=http://auth.cryptojackpot.local:30180
      - Cors__AllowedOrigins__3=http://localhost:30180

generatorOptions:
  disableNameSuffixHash: true

labels:
  - pairs:
      environment: local
    includeSelectors: false
