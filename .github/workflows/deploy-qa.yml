# =============================================================================
# Deploy QA
# Se ejecuta en: push a rama 'qa' (via PR desde develop)
# Hace:
#   1. Build + push de las 8 imágenes Docker al DOCR
#   2. terraform apply -var-file=environments/qa.tfvars
#      (crea/actualiza infra + secrets K8s + kustomize apply overlays/qa)
# =============================================================================
name: Deploy QA

on:
  push:
    branches: [qa]

concurrency:
  group: deploy-qa
  cancel-in-progress: false  # Nunca cancelar un deploy en curso

env:
  DOTNET_VERSION: "8.0.x"
  ENVIRONMENT: qa
  REGISTRY: registry.digitalocean.com/criptojackpot
  TF_DIR: infrastructure/terraform
  K8S_NAMESPACE: criptojackpot

jobs:
  # ---------------------------------------------------------------------------
  # Build & Push — construye y publica las imágenes con tag :qa
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "tag=qa-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Building with tag: qa-${SHORT_SHA}"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Login to DOCR
        run: doctl registry login --expiry-seconds 3600

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # BFF Gateway
      # -----------------------------------------------------------------------
      - name: Build & Push BFF
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/BFF/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/bff-gateway:qa
            ${{ env.REGISTRY }}/bff-gateway:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/bff-gateway:qa
          cache-to: type=inline

      # -----------------------------------------------------------------------
      # Identity
      # -----------------------------------------------------------------------
      - name: Build & Push Identity
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/Identity/Api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/identity-api:qa
            ${{ env.REGISTRY }}/identity-api:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/identity-api:qa
          cache-to: type=inline

      # -----------------------------------------------------------------------
      # Lottery
      # -----------------------------------------------------------------------
      - name: Build & Push Lottery
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/Lottery/Api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/lottery-api:qa
            ${{ env.REGISTRY }}/lottery-api:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/lottery-api:qa
          cache-to: type=inline

      # -----------------------------------------------------------------------
      # Order
      # -----------------------------------------------------------------------
      - name: Build & Push Order
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/Order/Api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/order-api:qa
            ${{ env.REGISTRY }}/order-api:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/order-api:qa
          cache-to: type=inline

      # -----------------------------------------------------------------------
      # Wallet
      # -----------------------------------------------------------------------
      - name: Build & Push Wallet
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/Wallet/Api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/wallet-api:qa
            ${{ env.REGISTRY }}/wallet-api:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/wallet-api:qa
          cache-to: type=inline

      # -----------------------------------------------------------------------
      # Winner
      # -----------------------------------------------------------------------
      - name: Build & Push Winner
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/Winner/Api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/winner-api:qa
            ${{ env.REGISTRY }}/winner-api:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/winner-api:qa
          cache-to: type=inline

      # -----------------------------------------------------------------------
      # Notification
      # -----------------------------------------------------------------------
      - name: Build & Push Notification
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/Notification/Api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/notification-api:qa
            ${{ env.REGISTRY }}/notification-api:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/notification-api:qa
          cache-to: type=inline

      # -----------------------------------------------------------------------
      # Audit
      # -----------------------------------------------------------------------
      - name: Build & Push Audit
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Microservices/Audit/Api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/audit-api:qa
            ${{ env.REGISTRY }}/audit-api:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/audit-api:qa
          cache-to: type=inline

  # ---------------------------------------------------------------------------
  # Terraform — actualiza infra QA y despliega manifiestos K8s
  # ---------------------------------------------------------------------------
  terraform-deploy:
    name: Terraform Deploy QA
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: qa  # Requiere aprobación en GitHub Environments (opcional)

    defaults:
      run:
        working-directory: ${{ env.TF_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.7"

      - name: Install doctl + kubectl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure AWS credentials for DO Spaces backend
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.DO_SPACES_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.DO_SPACES_SECRET_KEY }}" >> $GITHUB_ENV

      - name: Terraform Init (QA state)
        run: |
          terraform init \
            -backend-config="key=qa/terraform.tfstate" \
            -input=false

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file="environments/qa.tfvars" \
            -out=tfplan-qa \
            -input=false \
            -lock=true \
            -detailed-exitcode \
            2>&1 | tee plan-output.txt

          # Bloquear si el plan va a destruir recursos críticos
          if grep -E "must be replaced|will be destroyed|forces replacement" plan-output.txt | \
             grep -E "digitalocean_kubernetes_cluster|digitalocean_database_cluster|digitalocean_vpc|digitalocean_spaces_bucket"; then
            echo "❌ ERROR: El plan destruiría recursos críticos de infraestructura."
            echo "   Revisa los cambios manualmente antes de aplicar."
            echo "   Para proceder: usa terraform state mv o aplica manualmente."
            exit 1
          fi
        env:
          TF_VAR_do_token:                    ${{ secrets.DO_TOKEN }}
          TF_VAR_spaces_access_key:           ${{ secrets.DO_SPACES_ACCESS_KEY }}
          TF_VAR_spaces_secret_key:           ${{ secrets.DO_SPACES_SECRET_KEY }}
          TF_VAR_cloudflare_api_token:        ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id:          ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_jwt_secret_key:              ${{ secrets.QA_JWT_SECRET_KEY }}
          TF_VAR_kafka_bootstrap_servers:     ${{ secrets.QA_KAFKA_BOOTSTRAP_SERVERS }}
          TF_VAR_kafka_sasl_username:         ${{ secrets.QA_KAFKA_SASL_USERNAME }}
          TF_VAR_kafka_sasl_password:         ${{ secrets.QA_KAFKA_SASL_PASSWORD }}
          TF_VAR_redis_connection_string:     ${{ secrets.QA_REDIS_CONNECTION_STRING }}
          TF_VAR_mongodb_connection_string:   ${{ secrets.QA_MONGODB_CONNECTION_STRING }}
          TF_VAR_brevo_api_key:               ${{ secrets.QA_BREVO_API_KEY }}
        continue-on-error: true  # exitcode=2 significa cambios (es OK)

      - name: Terraform Apply
        if: steps.plan.outcome != 'failure'
        run: |
          terraform apply -auto-approve tfplan-qa
        env:
          TF_VAR_do_token:                    ${{ secrets.DO_TOKEN }}
          TF_VAR_spaces_access_key:           ${{ secrets.DO_SPACES_ACCESS_KEY }}
          TF_VAR_spaces_secret_key:           ${{ secrets.DO_SPACES_SECRET_KEY }}
          TF_VAR_cloudflare_api_token:        ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id:          ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_jwt_secret_key:              ${{ secrets.QA_JWT_SECRET_KEY }}
          TF_VAR_kafka_bootstrap_servers:     ${{ secrets.QA_KAFKA_BOOTSTRAP_SERVERS }}
          TF_VAR_kafka_sasl_username:         ${{ secrets.QA_KAFKA_SASL_USERNAME }}
          TF_VAR_kafka_sasl_password:         ${{ secrets.QA_KAFKA_SASL_PASSWORD }}
          TF_VAR_redis_connection_string:     ${{ secrets.QA_REDIS_CONNECTION_STRING }}
          TF_VAR_mongodb_connection_string:   ${{ secrets.QA_MONGODB_CONNECTION_STRING }}
          TF_VAR_brevo_api_key:               ${{ secrets.QA_BREVO_API_KEY }}

      - name: Connect kubectl to QA cluster
        run: |
          CLUSTER_ID=$(terraform output -raw cluster_id)
          doctl kubernetes cluster kubeconfig save "$CLUSTER_ID" \
            --context criptojackpot-qa

      - name: Update image tags in QA overlay
        run: |
          cd ${{ github.workspace }}
          TAG="${{ needs.build-and-push.outputs.image_tag }}"
          REGISTRY="${{ env.REGISTRY }}"

          cd infrastructure/k8s/overlays/qa
          kustomize edit set image \
            bff-gateway=${REGISTRY}/bff-gateway:${TAG} \
            identity-api=${REGISTRY}/identity-api:${TAG} \
            lottery-api=${REGISTRY}/lottery-api:${TAG} \
            order-api=${REGISTRY}/order-api:${TAG} \
            wallet-api=${REGISTRY}/wallet-api:${TAG} \
            winner-api=${REGISTRY}/winner-api:${TAG} \
            notification-api=${REGISTRY}/notification-api:${TAG} \
            audit-api=${REGISTRY}/audit-api:${TAG}

      - name: Commit updated image tags to qa branch
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infrastructure/k8s/overlays/qa/kustomization.yaml
          # Solo commitea si hay cambios reales
          git diff --cached --quiet || git commit -m "chore(qa): update image tags to ${{ needs.build-and-push.outputs.image_tag }} [skip ci]"
          git push origin qa

      - name: Apply Kustomize overlays/qa
        run: |
          kubectl apply -k infrastructure/k8s/overlays/qa \
            --context criptojackpot-qa \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --timeout=300s

      - name: Wait for rollout
        run: |
          DEPLOYMENTS=(
            bff-gateway identity-api lottery-api order-api
            wallet-api winner-api notification-api audit-api
          )
          for dep in "${DEPLOYMENTS[@]}"; do
            echo "Waiting for $dep..."
            kubectl rollout status deployment/$dep \
              --namespace ${{ env.K8S_NAMESPACE }} \
              --context criptojackpot-qa \
              --timeout=300s || echo "⚠️ $dep rollout timeout (non-blocking)"
          done

      - name: Smoke test - BFF healthcheck
        run: |
          sleep 10
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 15 \
            https://api-qa.criptojackpot.com/health || echo "000")
          echo "Health check status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "⚠️ Health check returned $HTTP_STATUS (may need time to propagate)"
          fi

      - name: Notify deploy success
        if: success()
        run: |
          echo "✅ QA deploy successful!"
          echo "  Commit: ${{ github.sha }}"
          echo "  Image tag: ${{ needs.build-and-push.outputs.image_tag }}"
          echo "  URL: https://api-qa.criptojackpot.com"

